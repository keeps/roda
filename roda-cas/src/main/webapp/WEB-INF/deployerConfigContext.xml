<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:p="http://www.springframework.org/schema/p"
	xmlns:tx="http://www.springframework.org/schema/tx" xmlns:sec="http://www.springframework.org/schema/security"
	xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.1.xsd
       http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-3.1.xsd
       http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security-3.1.xsd">


	<bean id="contextSource" class="org.springframework.ldap.core.support.LdapContextSource">
		<property name="pooled" value="false" />
		<property name="url" value="ldap://localhost" />
		<property name="baseEnvironmentProperties">
			<map>
				<entry key="com.sun.jndi.ldap.connect.timeout" value="3000" />
				<entry key="com.sun.jndi.ldap.read.timeout" value="3000" />
				<entry key="java.naming.security.authentication" value="simple" />
			</map>
		</property>
	</bean>

	<bean id="authenticationManager" class="org.jasig.cas.authentication.AuthenticationManagerImpl">
		<property name="credentialsToPrincipalResolvers">
			<list>
				<bean class="org.jasig.cas.authentication.principal.CredentialsToLDAPAttributePrincipalResolver">
					<property name="credentialsToPrincipalResolver">
						<bean class="org.jasig.cas.authentication.principal.UsernamePasswordCredentialsToPrincipalResolver">
							<property name="attributeRepository" ref="attributeRepository" />
						</bean>
					</property>
					<property name="filter" value="(uid=%u)" />
					<property name="principalAttributeName" value="uid" />
					<property name="searchBase" value="ou=users,dc=keep,dc=pt" />
					<property name="contextSource" ref="contextSource" />
					<property name="attributeRepository">
						<ref bean="attributeRepository" />
					</property>
				</bean>
				<bean class="org.jasig.cas.authentication.principal.HttpBasedServiceCredentialsToPrincipalResolver" />
			</list>
		</property>

		<property name="authenticationHandlers">
			<list>
				<bean class="org.jasig.cas.authentication.handler.support.HttpBasedServiceCredentialsAuthenticationHandler" p:httpClient-ref="httpClient" />
				<bean class="org.jasig.cas.adaptors.ldap.BindLdapAuthenticationHandler" p:filter="uid=%u" p:searchBase="ou=users,dc=keep,dc=pt" p:contextSource-ref="contextSource" />
			</list>
		</property>
	</bean>

	<!-- Security roles for the Services Management application -->
	<sec:user-service id="userDetailsService">
		<sec:user name="admin" password="roda" authorities="ROLE_ADMIN" />
	</sec:user-service>





	<!--<bean id="attributeRepository" class="org.jasig.services.persondir.support.ldap.LdapPersonAttributeDao">-->
	<bean id="attributeRepository" class="pt.keep.cas.RolesLdapPersonAttributeDao">
		<property name="contextSource" ref="contextSource" />
		<property name="requireAllQueryAttributes" value="true" />
		<property name="baseDN" value="ou=users,dc=keep,dc=pt" />
		<property name="groupsDN" value="ou=groups,dc=keep,dc=pt" />
		<property name="rolesDN" value="ou=roles,dc=keep,dc=pt" />
                <property name="queryAttributeMapping">
			<map>
				<entry key="username" value="uid" />
			</map>
		</property>
		<!--
		<property name="resultAttributeMapping">
			<map>
				<entry key="sn" value="lastName" />
				<entry key="givenName" value="firstName" />
				<entry key="mail" value="email" />
			</map>
		</property>
		-->
		
	</bean>

	<!-- Sample, in-memory data store for the ServiceRegistry. A real implementation 
		would probably want to replace this with the JPA-backed ServiceRegistry DAO 
		The name of this bean should remain "serviceRegistryDao". -->
	<bean id="serviceRegistryDao" class="org.jasig.cas.services.InMemoryServiceRegistryDaoImpl">
		<property name="registeredServices">
			<list>
				<bean class="org.jasig.cas.services.RegisteredServiceImpl">
                 			<property name="id" value="0" />
					<property name="name" value="HTTP" />
					<property name="description" value="Only Allows HTTP Urls" />
					<property name="serviceId" value="http://**" />
					<property name="evaluationOrder" value="10000001" />
					<property name="ignoreAttributes" value="true" />
					<property name="allowedToProxy" value="true" />
					<property name="enabled" value="true" />
					<property name="ssoEnabled" value="true" />
					<property name="anonymousAccess" value="false" />
				</bean>

				<bean class="org.jasig.cas.services.RegisteredServiceImpl">
					<property name="id" value="1" />
					<property name="name" value="HTTPS" />
					<property name="description" value="Only Allows HTTPS Urls" />
					<property name="serviceId" value="https://**" />
					<property name="evaluationOrder" value="10000002" />
					<property name="ignoreAttributes" value="true" />
					<property name="allowedToProxy" value="true" />
					<property name="enabled" value="true" />
					<property name="ssoEnabled" value="true" />
					<property name="anonymousAccess" value="false" />
				</bean>
			</list>
		</property>
	</bean>

	
	<!-- ST may be used exactly once and must be validated within 5 minutes. -->
<bean id="serviceTicketExpirationPolicy"
  class="org.jasig.cas.ticket.support.MultiTimeUseOrTimeoutExpirationPolicy">
  <constructor-arg
    index="0"
    value="1" />
  <constructor-arg
    index="1"
    value="300000" />
</bean>

	<bean id="auditTrailManager"
		class="com.github.inspektr.audit.support.Slf4jLoggingAuditTrailManager" />
	
	<bean id="healthCheckMonitor" class="org.jasig.cas.monitor.HealthCheckMonitor">
		<property name="monitors">
			<list>
				<bean class="org.jasig.cas.monitor.MemoryMonitor"
					p:freeMemoryWarnThreshold="10" />
				<!-- NOTE The following ticket registries support SessionMonitor: * DefaultTicketRegistry 
					* JpaTicketRegistry Remove this monitor if you use an unsupported registry. -->
				<bean class="org.jasig.cas.monitor.SessionMonitor"
					p:ticketRegistry-ref="ticketRegistry"
					p:serviceTicketCountWarnThreshold="5000"
					p:sessionCountWarnThreshold="100000" />
			</list>
		</property>
	</bean>
</beans>

